stages:
 - build
 - publish
 - test
 - scan

variables:
  SONAR_SCANNER_VERSION: 4.8.0.2856
  GIT_DEPTH: "0" 

build:
  stage: build
  tags:
    - linux
  script:
    - sudo apt-get update
    - sudo rm -rf /var/lib/dpkg/lock-frontend /var/lib/dpkg/lock /var/cache/debconf/*.dat /var/cache/apt/archives/lock
    - sudo dpkg --configure -a
    - sudo apt-get install -f
    - sudo apt-get install -y python3-dev python3-pip libasound2-dev
    - python3 setup.py sdist bdist_wheel
  artifacts:
    paths:
      - dist/*.tar.gz
      - dist/*.whl

publish:
  stage: publish
  tags:
    - linux
  script:
    - sudo apt-get update
    - sudo rm -rf /var/lib/dpkg/lock-frontend /var/lib/dpkg/lock /var/cache/debconf/*.dat /var/cache/apt/archives/lock
    - sudo dpkg --configure -a
    - sudo apt-get install -f
    - sudo apt-get install -y python3-dev python3-pip libasound2-dev
    - pip install twine
    - ~/.local/bin/twine upload --repository-url https://nexus.ellisbs.co.uk/repository/pypi-hosted/ --username $PYPI_USERNAME --password $PYPI_PASSWORD dist/*
  dependencies:
    - build

test_job:
  stage: test
  tags:
    - linux
  script:
    - export DEBIAN_FRONTEND=noninteractive
    - sudo apt-get update
    - sudo rm -rf /var/lib/dpkg/lock-frontend /var/lib/dpkg/lock /var/cache/debconf/*.dat /var/cache/apt/archives/lock
    - sudo dpkg --configure -a
    - sudo apt-get install -f
    - sudo dpkg-reconfigure keyboard-configuration
    - sudo apt-get install -y python3-dev python3-pip libasound2-dev
    - sudo apt-get install -y xvfb xserver-xorg-video-dummy
    - sh testscript.sh
  artifacts:
    paths:
      - coverage.xml

scan_job:
  stage: scan
  tags:
    - linux
  script:
    - export DEBIAN_FRONTEND=noninteractive
    - sudo apt-get update
    - sudo apt-get install -y keyboard-configuration
    - apt install --reinstall language-pack-en
    - sudo dpkg-reconfigure keyboard-configuration
    - sudo apt-get install -y unzip
    - if command -v sonar-scanner &> /dev/null; then echo "sonar-scanner already available."; else ./get_scanner.sh; fi
    - sonar-scanner -Dsonar.scm.provider=git
  dependencies:
    - test_job
  variables:
    TTY: 'true' # Add this line to enable TTY
